<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web Security Guardian - Admin Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #020617;
      color: #e5e7eb;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 30px 0;
      border-bottom: 2px solid #1f2937;
      margin-bottom: 30px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-icon {
      font-size: 48px;
    }

    .header-text h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .header-text p {
      color: #9ca3af;
      font-size: 14px;
    }

    .refresh-btn {
      padding: 12px 24px;
      background: #38bdf8;
      color: #020617;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
    }

    .refresh-btn:hover {
      background: #0ea5e9;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: #02081f;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 24px;
    }

    .stat-label {
      color: #9ca3af;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .stat-card.high .stat-value { color: #ef4444; }
    .stat-card.medium .stat-value { color: #facc15; }
    .stat-card.low .stat-value { color: #22c55e; }

    .table-container {
      background: #02081f;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 30px;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .table-title {
      font-size: 18px;
      font-weight: 600;
    }

    .filter-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 16px;
      background: #1f2937;
      color: #9ca3af;
      border: 1px solid #1f2937;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-btn:hover {
      border-color: #38bdf8;
    }

    .filter-btn.active {
      background: #38bdf8;
      color: #020617;
      border-color: #38bdf8;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    thead {
      border-bottom: 1px solid #1f2937;
    }

    th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      color: #9ca3af;
    }

    td {
      padding: 16px 12px;
      border-bottom: 1px solid #1f2937;
      font-size: 13px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background: #1f293750;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge.high {
      background: #ef444420;
      color: #ef4444;
    }

    .badge.medium {
      background: #facc1520;
      color: #facc15;
    }

    .badge.low {
      background: #22c55e20;
      color: #22c55e;
    }

    .permission-list {
      font-size: 12px;
      color: #9ca3af;
      max-width: 300px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: #9ca3af;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #1f2937;
      border-top-color: #38bdf8;
      border-radius: 50%;
      margin: 0 auto 16px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 60px;
      color: #9ca3af;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #1f2937;
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .list-item-name {
      font-weight: 500;
      font-size: 14px;
    }

    .list-item-count {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #9ca3af;
    }

    .risk-badge-small {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }

    .risk-badge-small.high { background: #ef4444; }
    .risk-badge-small.medium { background: #facc15; }
    .risk-badge-small.low { background: #22c55e; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-left">
        <div class="header-icon">üõ°Ô∏è</div>
        <div class="header-text">
          <h1>Web Security Guardian</h1>
          <p>Admin Dashboard - Real-time Security Monitoring</p>
        </div>
      </div>
      <button class="refresh-btn" onclick="loadDashboardData()">
        üîÑ Refresh Data
      </button>
    </header>

    <div id="loadingState" class="loading">
      <div class="spinner"></div>
      <p>Loading dashboard data...</p>
    </div>

    <div id="dashboardContent" style="display: none;">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Employees Monitored</div>
          <div class="stat-value" id="totalEmployees">0</div>
        </div>
        <div class="stat-card high">
          <div class="stat-label">High Risk Incidents</div>
          <div class="stat-value" id="highRiskCount">0</div>
        </div>
        <div class="stat-card medium">
          <div class="stat-label">Medium Risk Incidents</div>
          <div class="stat-value" id="mediumRiskCount">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Incidents</div>
          <div class="stat-value" id="totalIncidents">0</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="table-container">
          <div class="table-header">
            <h2 class="table-title">Top Risky Extensions</h2>
          </div>
          <div id="topExtensions"></div>
        </div>

        <div class="table-container">
          <div class="table-header">
            <h2 class="table-title">Top Risky Employees</h2>
          </div>
          <div id="topEmployees"></div>
        </div>
      </div>

      <div class="table-container">
        <div class="table-header">
          <h2 class="table-title">All Incidents</h2>
          <div class="filter-buttons">
            <button class="filter-btn active" onclick="filterIncidents('ALL')">All</button>
            <button class="filter-btn" onclick="filterIncidents('HIGH')">High Risk</button>
            <button class="filter-btn" onclick="filterIncidents('MEDIUM')">Medium Risk</button>
            <button class="filter-btn" onclick="filterIncidents('LOW')">Low Risk</button>
          </div>
        </div>
        <div class="table-wrapper">
          <table id="incidentsTable">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Employee ID</th>
                <th>Extension Name</th>
                <th>Risk Level</th>
                <th>Risk Score</th>
                <th>Permissions</th>
              </tr>
            </thead>
            <tbody id="incidentsTableBody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:5000/api';
    let currentFilter = 'ALL';
    let allIncidents = [];

    async function loadDashboardData() {
      try {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('dashboardContent').style.display = 'none';

        const statsResponse = await fetch(`${API_BASE}/stats`);
        const statsData = await statsResponse.json();

        const incidentsResponse = await fetch(`${API_BASE}/dashboard_data?limit=100`);
        const incidentsData = await incidentsResponse.json();

        allIncidents = incidentsData.incidents || [];

        updateStats(statsData);
        updateTopExtensions(statsData.top_extensions || []);
        updateTopEmployees(statsData.top_risky_employees || []);
        filterIncidents(currentFilter);

        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'block';
      } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('loadingState').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <h3>Failed to Connect</h3>
            <p>Make sure the backend server is running on http://localhost:5000</p>
            <br>
            <button class="refresh-btn" onclick="loadDashboardData()">Try Again</button>
          </div>
        `;
      }
    }

    function updateStats(data) {
      const overview = data.overview || {};
      document.getElementById('totalEmployees').textContent = overview.total_employees || 0;
      document.getElementById('highRiskCount').textContent = overview.high_risk_count || 0;
      document.getElementById('mediumRiskCount').textContent = overview.medium_risk_count || 0;
      document.getElementById('totalIncidents').textContent = overview.total_incidents || 0;
    }

    function updateTopExtensions(extensions) {
      const container = document.getElementById('topExtensions');
      
      if (extensions.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No extension data yet</p></div>';
        return;
      }

      container.innerHTML = extensions.map(ext => `
        <div class="list-item">
          <div class="list-item-name">${ext.name}</div>
          <div class="list-item-count">
            <span class="risk-badge-small ${ext.risk_level.toLowerCase()}"></span>
            ${ext.count} reports
          </div>
        </div>
      `).join('');
    }

    function updateTopEmployees(employees) {
      const container = document.getElementById('topEmployees');
      
      if (employees.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No employee data yet</p></div>';
        return;
      }

      container.innerHTML = employees.map(emp => `
        <div class="list-item">
          <div class="list-item-name">${emp.employee_id}</div>
          <div class="list-item-count">
            <span class="risk-badge-small high"></span>
            ${emp.high_count} high,
            <span class="risk-badge-small medium"></span>
            ${emp.medium_count} medium
          </div>
        </div>
      `).join('');
    }

    function filterIncidents(level) {
      currentFilter = level;
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event?.target?.classList.add('active');

      let filtered = allIncidents;
      if (level !== 'ALL') {
        filtered = allIncidents.filter(inc => inc.risk_level === level);
      }

      const tbody = document.getElementById('incidentsTableBody');
      
      if (filtered.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px; color: #9ca3af;">
              No incidents found
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filtered.map(incident => {
        const date = new Date(incident.timestamp);
        const formattedDate = date.toLocaleString();
        const permissions = incident.permissions.slice(0, 3).join(', ');
        const morePerms = incident.permissions.length > 3 ? ` +${incident.permissions.length - 3} more` : '';
        
        // NEW: Risk flags display (traceability)
        let flagsHtml = '';
        if (incident.flags && incident.flags.length > 0) {
          flagsHtml = '<div style="margin-top: 8px; font-size: 11px;">';
          incident.flags.forEach(flag => {
            const flagColor = flag.severity === 'CRITICAL' ? '#ef4444' : '#f59e0b';
            flagsHtml += `<div style="color: ${flagColor}; margin: 2px 0;">üö© ${flag.id}: ${flag.title}</div>`;
          });
          flagsHtml += '</div>';
        }

        return `
          <tr onclick="showIncidentDetails(${JSON.stringify(incident).replace(/"/g, '&quot;')})" style="cursor: pointer;">
            <td>${formattedDate}</td>
            <td><strong>${incident.employee_id}</strong></td>
            <td>
              ${incident.extension_name}
              ${flagsHtml}
            </td>
            <td><span class="badge ${incident.risk_level.toLowerCase()}">${incident.risk_level}</span></td>
            <td><strong>${incident.risk_score}</strong></td>
            <td class="permission-list">${permissions}${morePerms}</td>
          </tr>
        `;
      }).join('');
    }
    
    // NEW: Show detailed incident modal with risk flags
    function showIncidentDetails(incident) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; overflow-y: auto; padding: 20px;';
      
      let flagsSection = '';
      if (incident.flags && incident.flags.length > 0) {
        flagsSection = '<div style="margin: 20px 0;"><h3 style="color: #ef4444; margin-bottom: 12px;">üö© RISK FLAGS - WHY THIS SCORE IS HIGH</h3>';
        incident.flags.forEach(flag => {
          const bgColor = flag.severity === 'CRITICAL' ? '#dc2626' : '#f59e0b';
          flagsSection += `
            <div style="background: #0f172a; border: 2px solid ${bgColor}; border-radius: 8px; padding: 12px; margin: 10px 0;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong style="color: #f8fafc;">${flag.id}: ${flag.title}</strong>
                <span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; background: ${bgColor}; color: white;">${flag.severity}</span>
              </div>
              <div style="color: #fbbf24; font-size: 12px; margin: 6px 0;"><strong>Reason:</strong> ${flag.reason}</div>
              <div style="color: #94a3b8; font-size: 11px; margin: 4px 0;"><strong>Policy:</strong> ${flag.policy}</div>
            </div>
          `;
        });
        flagsSection += '</div>';
      }
      
      modal.innerHTML = `
        <div style="background: #1e293b; border-radius: 12px; padding: 24px; max-width: 800px; margin: 0 auto; border: 2px solid #38bdf8;">
          <h2 style="color: #38bdf8; margin-bottom: 16px;">Incident Details</h2>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px;">
            <div>
              <div style="color: #9ca3af; font-size: 12px;">Employee ID</div>
              <div style="font-size: 16px; font-weight: bold;">${incident.employee_id}</div>
            </div>
            <div>
              <div style="color: #9ca3af; font-size: 12px;">Timestamp</div>
              <div style="font-size: 16px;">${new Date(incident.timestamp).toLocaleString()}</div>
            </div>
            <div>
              <div style="color: #9ca3af; font-size: 12px;">Extension Name</div>
              <div style="font-size: 16px; font-weight: bold;">${incident.extension_name}</div>
            </div>
            <div>
              <div style="color: #9ca3af; font-size: 12px;">Risk Score</div>
              <div style="font-size: 24px; font-weight: bold; color: ${incident.risk_level === 'HIGH' ? '#ef4444' : '#f59e0b'};">${incident.risk_score}/100</div>
            </div>
          </div>
          
          ${flagsSection}
          
          <div style="margin: 20px 0;">
            <h4 style="color: #38bdf8; margin-bottom: 8px;">Requested Permissions</h4>
            <div style="background: #0f172a; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 11px;">
              ${incident.permissions.join(', ')}
            </div>
          </div>
          
          <div style="margin: 20px 0;">
            <h4 style="color: #38bdf8; margin-bottom: 8px;">Host Access</h4>
            <div style="background: #0f172a; padding: 12px; border-radius: 8px; font-family: monospace; font-size: 11px;">
              ${incident.host_access.join(', ') || 'None'}
            </div>
          </div>
          
          <button onclick="document.body.removeChild(this.parentElement.parentElement)" style="margin-top: 20px; padding: 10px 20px; background: #38bdf8; color: #020617; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%;">
            Close
          </button>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    // Load data on page load
    window.addEventListener('DOMContentLoaded', loadDashboardData);
  </script>
</body>
</html>
